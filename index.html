<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Telegram Clicker</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #020617;
  color: white;
  text-align: center;
  padding: 30px;
}
h1 { margin-bottom: 5px; }
#score { font-size: 36px; margin: 10px 0; }
#energy { margin-bottom: 20px; }
button {
  padding: 15px 35px;
  font-size: 20px;
  border: none;
  border-radius: 14px;
  background: #22c55e;
  cursor: pointer;
  margin: 10px;
}
.shop, .leaders {
  margin-top: 30px;
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 12px;
  padding: 15px;
}
.item {
  display: flex;
  justify-content: space-between;
  margin: 10px 0;
}
</style>
</head>

<body>

<h1>üî• Telegram Clicker</h1>
<p id="user">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

<div id="score">–û—á–∫–∏: 0</div>
<div id="energy">‚ö° –≠–Ω–µ—Ä–≥–∏—è: 10 / 10</div>

<button onclick="clickMe()">–ö–õ–ò–ö</button>

<div class="shop">
<h2>üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
<div class="item">
  <span>+1 –∑–∞ –∫–ª–∏–∫</span>
  <button onclick="buyUpgrade()">–ö—É–ø–∏—Ç—å (50)</button>
</div>
</div>

<div class="leaders">
<h2>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>
<div id="leaderboard">–ü—É—Å—Ç–æ</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

let score = 0;
let power = 1;
let energy = 10;
let maxEnergy = 10;

const scoreEl = document.getElementById('score');
const energyEl = document.getElementById('energy');
const leaderboardEl = document.getElementById('leaderboard');

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
const user = tg.initDataUnsafe.user;
const userId = user?.id || Math.random();
const username = user?.username || '–ò–≥—Ä–æ–∫';

document.getElementById('user').innerText =
  `–ò–≥—Ä–æ–∫: @${username}`;

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
tg.CloudStorage.getItems(
  ['score', 'power', 'energy', 'leaders'],
  (err, data) => {
    if (!err) {
      score = parseInt(data.score) || 0;
      power = parseInt(data.power) || 1;
      energy = parseInt(data.energy) || maxEnergy;
      updateUI();
      updateLeaders();
    }
  }
);

function clickMe() {
  if (energy <= 0) {
    tg.showAlert('‚ö° –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!');
    return;
  }
  score += power;
  energy--;
  save();
  updateUI();
}

function buyUpgrade() {
  if (score < 50) {
    tg.showAlert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤');
    return;
  }
  score -= 50;
  power++;
  save();
  updateUI();
}

function updateUI() {
  scoreEl.innerText = `–û—á–∫–∏: ${score}`;
  energyEl.innerText = `‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${energy} / ${maxEnergy}`;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + –ª–∏–¥–µ—Ä–±–æ—Ä–¥
function save() {
  tg.CloudStorage.setItem('score', score.toString());
  tg.CloudStorage.setItem('power', power.toString());
  tg.CloudStorage.setItem('energy', energy.toString());

  tg.CloudStorage.getItem('leaders', (err, value) => {
    let leaders = value ? JSON.parse(value) : {};
    leaders[userId] = { username, score };
    tg.CloudStorage.setItem('leaders', JSON.stringify(leaders));
    updateLeaders(leaders);
  });
}

// –õ–∏–¥–µ—Ä–±–æ—Ä–¥
function updateLeaders(data) {
  if (!data) {
    tg.CloudStorage.getItem('leaders', (e, v) => {
      if (v) updateLeaders(JSON.parse(v));
    });
    return;
  }

  const sorted = Object.values(data)
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);

  leaderboardEl.innerHTML = sorted
    .map((u, i) => `#${i + 1} ${u.username}: ${u.score}`)
    .join('<br>');
}

// –†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏
setInterval(() => {
  if (energy < maxEnergy) {
    energy++;
    save();
    updateUI();
  }
}, 5000);
</script>

</body>
</html>
